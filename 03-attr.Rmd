# Working with attribute table {#attr}

## Prerequisites {-}

- You need **dplyr** installed
- You must have run the code in Chapter 1

```{r, echo=FALSE, include=FALSE}
source("code/01-introduction.R")
```

## Introduction

Attribute data is non-geographical information associated with columns geometry.
**sf** makes working with attribute data because objects of class `sf` are data frames.
This is illustrated below for the `w` object representing the countries of the world:

```{r}
class(w)
```

This 'world' dataset contains 63 non-geographical variables (and one geometry column) with data for almost 200 countries, as can be ascertained using base functions for working with tabular data:

```{r}
dim(w) # it is a 2 dimensional object, with rows and columns
nrow(w) # how many rows?
ncol(w) # how many columns?
```

Extracting the attribute data of an `sf` object is the same as removing the geometry column:

```{r}
w_df = w
st_geometry(w_df) = NULL
class(w_df)
```

This can be useful if the geometry column causes problem, e.g. by occupying large amounts of RAM.
However, for most cases there is no harm in keeping the geometry column, as data frame operations on `sf` will only act on the attribute data.
For this reason, being good at working with attribute data in geographical data is the same being proficient at handling data frames in R.
For many applications, the most effective and intuitive way to work with data frames is with the **dplyr** package.
The subsequent examples briefly demonstrate how attribute data in `sf` objects can be manipulated using R's base `data.frame` handling function before moving on to the more expressive **dplyr approach.

## Handling attribute data with base R

`sf` objects behave exactly the same as `data.frame` objects for most base R operations, including subsetting rows and columns, creating new variables and modelling, as illustrated in the code examples below.

```{r, eval=FALSE}
w[1:6, ] # subsetting rows
```

```{r}
w[, 1:3] # subsetting columns
```

Note that after each operation, the geometry column is preserved.

## Handling attribute data with dplyr

**dplyr** makes working with data frames easier and is compatible with `sf` objects, after the package has been loaded:

```{r, message=FALSE}
library(dplyr)
```

`dplyr` is a powerful package and sub-language of R in its own right, worthy of study in its own right.
The `select()` function, for example, can be used to both subset and renames columns in a single line, for example:

```{r}
w = select(w, name, continent, population = pop_est)
head(w)
```

This is more concises than the base R equivalent:

```{r}
w = w[c("name", "continent", "pop_est")] # subset columns by name
names(w)[3] = "population" # rename column manually

w_few_cols2 = w %>%
        select(., name, continent)

head(w_few_cols2)
```

```{r}
# ==, !=, >, >=, <, <=, &, |

# subsetting simple feature rows by values
w_few_rows = w[w$pop_est>1000000000, ]

#OR
w_few_rows = w %>% 
        filter(., pop_est>1000000000)

head(w_few_rows)
```

```{r}
# add a new column
w$area = raster::area(as(w, "Spatial")) / 1000000 #it there any function for area calculation on sf object?
w$pop_density = w$pop_est / w$area

# OR

w = w %>% 
        mutate(area=raster::area(as(., "Spatial")) / 1000000) %>% 
        mutate(pop_density=pop_est/area)
```

```{r}
# data summary
summary(w)

# data summary by groups
w_continents = w %>% 
        group_by(continent) %>% 
        summarise(continent_pop=sum(pop_est), country_n=n())
w_continents
```

```{r}
# sort variables
## by name
w_continents %>% 
        arrange(continent)
## by population (in descending order)
w_continents %>% 
        arrange(-continent_pop)
```

Most of the function from **sf** package do not drop a `geometry` column. To extract a data frame `st_geometry()` or `st_set_geometry()` function can be used.

```{r}
w_st = w
st_geometry(w_st) = NULL
class(w_st)

# OR

w_st2 = w
w_st2 = w_st2 %>% st_set_geometry(., NULL)
class(w_st2)
```


<!-- 
- dplyr, tidyr, and purrr packages
- lubridate??
- pipes
-->

<!-- 
- view, add new rows/columns, subset, select, summarize 
-->
